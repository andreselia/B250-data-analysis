# Overview

This script processes PRICE ORF tables to extract, concatenate, and translate ORF DNA sequences into peptide sequences, organizes outputs by cell type and treatment, and generates summary tables and visualization plots. Peptide uniqueness is enforced within each cell type: only peptides found exclusively in a single treatment are kept.

# Input Files and Folder Structure

**Required Inputs:**

- **PRICE ORF tables (TSV):**  
  `<BASE_DIR>/<project_id>/analysis/output/PRICE/output/`  
  Generated by PRICE, filenames ending with `_toGenome.bam.orfs.tsv`.

- **Genome Reference (BSgenome):**  
  Either `BSgenome.Mmusculus.UCSC.mm10` (mouse) or `BSgenome.Hsapiens.UCSC.hg19` (human).

- **Script Arguments:**  
  1. `project_id` (e.g., `43979`)
  2. `species` (e.g., `mm10` or `hg19`)
  3. `celltypes` (underscore-delimited string, e.g., `NP5_TC1`)
  4. `min_peptide_length` (minimum peptide length to keep)

**Output Folders:**

- All results saved to  
  `<BASE_DIR>/<project_id>/analysis/output/PRICE/ORF_to_Peptide/`

# How to Run

Prepare your cluster environment (Debian, RStudio) and necessary modules, then use:

```

module load R/4.4.3-GCCcore-14.1.0
bsub -q long -R rusage[mem=40G] Rscript /path/to/ORF_dna_to_peptide_table.r <project_id> <species> <celltype1_celltype2_...> <min_peptide_length>

```

**Example:**
```

bsub -q long -R rusage[mem=40G] Rscript /omics/groups/OE0532/internal/Andres/scripts/scripts_andres/ORF_dna_to_peptide_table.r 43979 mm10 NP5_TC1 10

```

To transfer output to your workstation:
```

scp -r user@cluster:/omics/groups/OE0532/internal/Andres/<project_id>/analysis/output/PRICE/ORF_to_Peptide ~/analysis/<project_id>/

```

# Critical Steps and Workflow

## 1. ORF Table Loading and Filtering

All PRICE output `.tsv` files are read, excluding those in folders named "ORF_tables".  
Columns are filtered for valid ORFs (`Type` contains "ORF", `p value < 0.05`).

## 2. Genome Loading

The BSgenome reference is loaded for the indicated `species` (mouse or human), enabling accurate DNA extraction by chromosome coordinates.

## 3. Location and Range Parsing

- Chromosome, strand, and exon/intron ranges are parsed from the "Location" field.
- Pipe (`|`) denotes intron boundaries in coordinates; segments are merged and concatenated for spliced sequence.
- **+1 is added to all start coordinates**, converting PRICE's 0-based system to Bioconductor's 1-based system.

## 4. Spliced DNA Extraction

All exonic segments for each ORF/sample are:
- Split, merged (adjacent or overlapping ranges combined).
- DNA is extracted from the reference with strand specificity and concatenated for translation.

## 5. Peptide Translation and Annotation

- DNA is translated with `Biostrings`.
- Start codon matches, peptide length, and stop codons are checked and annotated.
- Metadata columns for peptide properties and treatments are added.

## 6. Filtering Unique Peptides (Key Step)

Only peptides **unique to a single treatment** per cell type are kept:

```

filtered_df %>%
filter(Peptide_Length >= min_peptide_length) %>%
group_by(CellType, Peptide_Sequence) %>%
filter(n_distinct(Treatment) == 1) %>%
ungroup()

```

Final tables and FASTA files for these unique peptides are written per cell type.

## 7. Output and Visualization

- **Tables:**  
  - All processed ORFs and peptides.  
  - Unique peptides per cell type/treatment.

- **FASTA:**  
  - All unique peptide sequences by cell type.

- **Plots:**  
  - Peptide length distributions (histogram, strand-split).
  - Initiation codon usage and stop codon positions.
  - ORF type frequencies.
  - All plots saved as PDFs in the output folder.

# Additional Notes

- The start position correction (+1) is always applied, reflecting PRICE/BED's 0-based convention and Bioconductor's 1-based requirement.
- Pipe-separated ranges are treated as exons; their DNA is concatenated for translation.
- Peptide uniqueness is enforced strictly within cell type/treatment context.
- All code uses `dplyr`, `tidyverse`, and Bioconductor genomics packages for reproducibility and performance.

# List of Required R Packages

These must be installed and loaded:

```

library(readr)
library(dplyr)
library(stringr)
library(GenomicRanges)
library(Biostrings)
library(BSgenome.Hsapiens.UCSC.hg19)
library(BSgenome.Mmusculus.UCSC.mm10)
library(ggplot2)
library(patchwork)

```

For installation (if not yet installed):

```

install.packages(c("readr", "dplyr", "stringr", "ggplot2", "patchwork"))
if (!requireNamespace("BiocManager", quietly = TRUE))
install.packages("BiocManager")
BiocManager::install(c("GenomicRanges", "Biostrings",
"BSgenome.Hsapiens.UCSC.hg19",
"BSgenome.Mmusculus.UCSC.mm10"))

```
